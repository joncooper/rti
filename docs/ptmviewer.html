<!DOCTYPE html>  <html> <head>   <title>ptmviewer.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> <script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-28892801-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
</head>
 <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="assertions.html">                 assertions.coffee               </a>                                           <a class="source" href="binaryfile.html">                 binaryfile.coffee               </a>                                           <a class="source" href="bundle.html">                 bundle.coffee               </a>                                           <a class="source" href="dataviewstream.html">                 dataviewstream.coffee               </a>                                           <a class="source" href="math.html">                 math.coffee               </a>                                           <a class="source" href="ptm.html">                 ptm.coffee               </a>                                           <a class="source" href="ptmviewer.html">                 ptmviewer.coffee               </a>                                           <a class="source" href="rti.html">                 rti.coffee               </a>                                           <a class="source" href="rtiviewer.html">                 rtiviewer.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               ptmviewer.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">vertexShader = </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">varying vec2 pos;</span>

<span class="s2">void main() {</span>
<span class="s2">  gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);</span>
<span class="s2">  pos = uv;</span>
<span class="s2">}</span>

<span class="s2">&quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>We have to rehydrate the coefficients in the shader, even though they are invariant over lighting direction.
Why? We can't pass a floating-point texture with vanilla GLSL.</p>

<p>We need floats per pixel; imagine we have a pixel that looks like:
   raw coefficient = 44
   bias            = 234
   scale           = 2.0
We compute a 'rehydrated' coefficient that is == -380. Which is unfortunately not expressible as a uint8.</p>

<p>The options are: implement a floating-point encoding scheme like IEEE 754, or just rely on the fact that the GPU is fast :)
An additional multiply and a subtract per pixel never hurt anyone!</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fragmentShader = </span><span class="s2">&quot;&quot;&quot;</span>

<span class="s2">varying vec2 pos;</span>

<span class="s2">uniform vec3 s0s1s2;</span>
<span class="s2">uniform vec3 s3s4s5;</span>
<span class="s2">uniform vec3 b0b1b2;</span>
<span class="s2">uniform vec3 b3b4b5;</span>
<span class="s2">uniform float Lu;</span>
<span class="s2">uniform float Lv;</span>
<span class="s2">uniform int drawNormalsMode;</span>
<span class="s2">uniform float diffuseGain;</span>
<span class="s2">uniform sampler2D luminanceCoefficients012;</span>
<span class="s2">uniform sampler2D luminanceCoefficients345;</span>
<span class="s2">uniform sampler2D chrominance;</span>

<span class="s2">// See http://www.hpl.hp.com/research/ptm/papers/Eq19Correction.pdf</span>

<span class="s2">vec2 maximumLuminance(in vec4 a0a1a2, in vec4 a3a4a5) {</span>
<span class="s2">  highp float a0, a1, a2, a3, a4, a5;</span>
<span class="s2">  a0 = a0a1a2.x;</span>
<span class="s2">  a1 = a0a1a2.y;</span>
<span class="s2">  a2 = a0a1a2.z;</span>
<span class="s2">  a3 = a3a4a5.x;</span>
<span class="s2">  a4 = a3a4a5.y;</span>
<span class="s2">  a5 = a3a4a5.z;</span>

<span class="s2">  float lu0 = ((a2 * a4) - (2.0 * a1 * a3)) / ((4.0 * a0 * a1) - (a2 * a2));</span>
<span class="s2">  float lv0 = ((a2 * a3) - (2.0 * a0 * a4)) / ((4.0 * a0 * a1) - (a2 * a2));</span>
<span class="s2">  return vec2(lu0, lv0);</span>
<span class="s2">}</span>

<span class="s2">vec3 recoveredSurfaceNormal(in vec4 a0a1a2, in vec4 a3a4a5) {</span>
<span class="s2">  vec2 maxL = maximumLuminance(a0a1a2, a3a4a5);</span>
<span class="s2">  float normalZ = sqrt(1.0 - (maxL.x * maxL.x) - (maxL.y * maxL.y));</span>
<span class="s2">  vec3 recoveredNormal = vec3(maxL, normalZ);</span>
<span class="s2">  return recoveredNormal;</span>
<span class="s2">}</span>

<span class="s2">void applyDiffuseGain(float gain, inout vec4 a0a1a2, inout vec4 a3a4a5) {</span>
<span class="s2">  highp float a0, a1, a2, a3, a4, a5, a0p, a1p, a2p, a3p, a4p, a5p, lu0, lv0;</span>
<span class="s2">  vec2 maxL;</span>

<span class="s2">  a0 = a0a1a2.x;</span>
<span class="s2">  a1 = a0a1a2.y;</span>
<span class="s2">  a2 = a0a1a2.z;</span>
<span class="s2">  a3 = a3a4a5.x;</span>
<span class="s2">  a4 = a3a4a5.y;</span>
<span class="s2">  a5 = a3a4a5.z;</span>

<span class="s2">  maxL = maximumLuminance(a0a1a2, a3a4a5);</span>
<span class="s2">  lu0 = maxL.x;</span>
<span class="s2">  lv0 = maxL.y;</span>

<span class="s2">  a0p = gain * a0;</span>
<span class="s2">  a1p = gain * a1;</span>
<span class="s2">  a2p = gain * a2;</span>
<span class="s2">  a3p = (1.0 - gain) * ((2.0 * a0 * lu0) + (a2 * lv0)) + a3;</span>
<span class="s2">  a4p = (1.0 - gain) * ((2.0 * a1 * lv0) + (a2 * lu0)) + a4;</span>
<span class="s2">  a5p = (1.0 - gain) * ((a0 * lu0 * lu0) + (a1 * lv0 * lv0) + (a2 * lu0 * lv0)) + ((a3 - a3p) * lu0) + ((a4 - a4p) * lv0) + a5;</span>

<span class="s2">  a0a1a2 = vec4(a0p, a1p, a2p, 0.0);</span>
<span class="s2">  a3a4a5 = vec4(a3p, a4p, a5p, 0.0);</span>
<span class="s2">  return;</span>
<span class="s2">}</span>

<span class="s2">void main() {</span>
<span class="s2">  vec4 a0a1a2 = texture2D(luminanceCoefficients012, pos);</span>
<span class="s2">  vec4 a3a4a5 = texture2D(luminanceCoefficients345, pos);</span>

<span class="s2">  // GLSL vector operations are componentwise</span>

<span class="s2">  a0a1a2.xyz = (a0a1a2.xyz - b0b1b2.xyz) * s0s1s2.xyz;</span>
<span class="s2">  a3a4a5.xyz = (a3a4a5.xyz - b3b4b5.xyz) * s3s4s5.xyz;</span>

<span class="s2">  if (diffuseGain &gt; 0.0) {</span>
<span class="s2">    applyDiffuseGain(diffuseGain, a0a1a2, a3a4a5);</span>
<span class="s2">  }</span>

<span class="s2">  // intensity = (a0 * Lu^2) + (a1 * Lv^2) + (a2 * Lu * Lv) + (a3 * Lu) + (a4 * Lv) + a5;</span>

<span class="s2">  float intensity = dot(a0a1a2, vec4(Lu*Lu, Lv*Lv, Lu*Lv, 0.0)) + dot(a3a4a5, vec4(Lu, Lv, 1.0, 0.0));</span>
<span class="s2">  vec4 rgb = texture2D(chrominance, pos);</span>

<span class="s2">  gl_FragColor = rgb * intensity;</span>
<span class="s2">  gl_FragColor.a = 1.0;</span>

<span class="s2">  if (drawNormalsMode == 1) {</span>
<span class="s2">    gl_FragColor = vec4(recoveredSurfaceNormal(a0a1a2, a3a4a5), 1.0);</span>
<span class="s2">  }</span>
<span class="s2">}</span>

<span class="s2">&quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Build the set of uniforms that will be passed to the shaders</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">buildUniforms = </span><span class="nf">(ptm) -&gt;</span>
  <span class="nv">lightCoordinates = </span><span class="p">{</span> <span class="nv">u: </span><span class="mf">0.1</span><span class="p">,</span> <span class="nv">v: </span><span class="mf">0.1</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Turn a raw texture buffer into a THREE (and GL) texture, and push it to the GPU</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeTexture = </span><span class="p">(</span><span class="nx">uint8textureData</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nv">t = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">DataTexture</span><span class="p">(</span><span class="nx">uint8textureData</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">height</span><span class="p">,</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">RGBFormat</span><span class="p">)</span>
    <span class="nv">t.needsUpdate = </span><span class="kc">true</span>
    <span class="k">return</span> <span class="nx">t</span>

  <span class="nv">uniforms =</span>
    <span class="nv">b0b1b2:</span>
      <span class="nv">type: </span><span class="s1">&#39;v3&#39;</span>
      <span class="nv">value: </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">bias</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">bias</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">bias</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">)</span>
    <span class="nv">b3b4b5:</span>
      <span class="nv">type: </span><span class="s1">&#39;v3&#39;</span>
      <span class="nv">value: </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">bias</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">bias</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">bias</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">/</span><span class="mf">255.0</span><span class="p">)</span>
    <span class="nv">s0s1s2:</span>
      <span class="nv">type: </span><span class="s1">&#39;v3&#39;</span>
      <span class="nv">value: </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="nv">s3s4s5:</span>
      <span class="nv">type: </span><span class="s1">&#39;v3&#39;</span>
      <span class="nv">value: </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">scale</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
    <span class="nv">Lu:</span>
      <span class="nv">type: </span><span class="s1">&#39;f&#39;</span>
      <span class="nv">value: </span><span class="nx">lightCoordinates</span><span class="p">.</span><span class="nx">u</span>
    <span class="nv">Lv:</span>
      <span class="nv">type: </span><span class="s1">&#39;f&#39;</span>
      <span class="nv">value: </span><span class="nx">lightCoordinates</span><span class="p">.</span><span class="nx">v</span>
    <span class="nv">drawNormalsMode:</span>
      <span class="nv">type: </span><span class="s1">&#39;i&#39;</span>
      <span class="nv">value: </span><span class="mi">0</span>
    <span class="nv">luminanceCoefficients012:</span>
      <span class="nv">type: </span><span class="s1">&#39;t&#39;</span>
      <span class="nv">value: </span><span class="mi">0</span>
      <span class="nv">texture: </span><span class="nx">makeTexture</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">tex0</span><span class="p">)</span>
    <span class="nv">luminanceCoefficients345:</span>
      <span class="nv">type: </span><span class="s1">&#39;t&#39;</span>
      <span class="nv">value: </span><span class="mi">1</span>
      <span class="nv">texture: </span><span class="nx">makeTexture</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">tex1</span><span class="p">)</span>
    <span class="nv">chrominance:</span>
      <span class="nv">type: </span><span class="s1">&#39;t&#39;</span>
      <span class="nv">value: </span><span class="mi">2</span>
      <span class="nv">texture: </span><span class="nx">makeTexture</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">tex2</span><span class="p">)</span>
    <span class="nv">diffuseGain:</span>
      <span class="nv">type: </span><span class="s1">&#39;f&#39;</span>
      <span class="nv">value: </span><span class="mf">0.0</span>

  <span class="k">return</span> <span class="nx">uniforms</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h3>Draw the scene and attach mouse handlers</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">drawScene = </span><span class="nf">(ptm) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Attach the renderer</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">renderer = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">WebGLRenderer</span><span class="p">()</span>
  <span class="nx">renderer</span><span class="p">.</span><span class="nx">setSize</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">renderer</span><span class="p">.</span><span class="nx">domElement</span><span class="p">)</span>
  <span class="nx">renderer</span><span class="p">.</span><span class="nx">setClearColorHex</span><span class="p">(</span><span class="mh">0x555555</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
  <span class="nx">renderer</span><span class="p">.</span><span class="nx">clear</span><span class="p">()</span>
  <span class="nv">canvas = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three &gt; canvas&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Set up the scene</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">scene = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Scene</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 100.0)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">camera = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">OrthographicCamera</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">)</span>
  <span class="nv">camera.position.z = </span><span class="mf">100.0</span>
  <span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">camera</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Bind the uniforms and shaders to the plane we'll use for display</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">uniforms = </span><span class="nx">buildUniforms</span><span class="p">(</span><span class="nx">ptm</span><span class="p">)</span>
  <span class="vi">@material = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">ShaderMaterial</span><span class="p">(</span>
    <span class="nv">uniforms: </span><span class="nx">uniforms</span>
    <span class="nv">fragmentShader: </span><span class="nx">fragmentShader</span>
    <span class="nv">vertexShader: </span><span class="nx">vertexShader</span>
  <span class="p">)</span>

  <span class="nv">plane = </span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">@material</span>
  <span class="p">)</span>
  <span class="nv">plane.scale.x = </span><span class="mf">2.0</span>
  <span class="nv">plane.scale.y = </span><span class="mf">2.0</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Complete building the scene</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">plane</span><span class="p">)</span>
  <span class="nx">scene</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">camera</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Map (x,y) on the canvas from space [(0, width), (0, height)] -> [(-1, 1), (1, -1)]</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">canvasPointToLightSpacePoint = </span><span class="nf">(x, y) -&gt;</span>
    <span class="nv">x = </span><span class="p">((</span><span class="nx">x</span> <span class="err">/ canvas.width)  * 2) - 1</span>
    <span class="nv">y = </span><span class="p">(((</span><span class="nx">y</span> <span class="err">/ canvas.height) * 2) - 1) * -1</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h3>Bind mouse handlers</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Mouse move handler - relight based upon mouse position</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">moveHandler = </span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">@dragging</span>
    <span class="p">[</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">canvasPointToLightSpacePoint</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">)</span>

    <span class="nv">phi   = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span><span class="nx">y</span><span class="p">,</span> <span class="nx">x</span><span class="p">)</span>
    <span class="nv">r     = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">x</span><span class="o">*</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">y</span><span class="o">*</span><span class="nx">y</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1</span>
    <span class="nv">lx    = </span><span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span><span class="nx">phi</span><span class="p">)</span>
    <span class="nv">ly    = </span><span class="nx">r</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span><span class="nx">phi</span><span class="p">)</span>

    <span class="vi">@material.uniforms.Lu.value = </span><span class="nx">lx</span>
    <span class="vi">@material.uniforms.Lv.value = </span><span class="nx">ly</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Drag handler - pan</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">panHandler = </span><span class="nf">(event) -&gt;</span>
    <span class="nv">deltaX = </span><span class="nx">event</span><span class="p">.</span><span class="nx">offsetX</span> <span class="o">-</span> <span class="nx">@dragStart</span><span class="p">.</span><span class="nx">x</span>
    <span class="nv">deltaY = </span><span class="nx">event</span><span class="p">.</span><span class="nx">offsetY</span> <span class="o">-</span> <span class="nx">@dragStart</span><span class="p">.</span><span class="nx">y</span>
    <span class="nv">plane.position.x = </span><span class="nx">planeStart</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="p">((</span><span class="nx">deltaX</span> <span class="err">/ (canvas.width * plane.scale.x)) * (2.0 * plane.scale.x))</span>
    <span class="nv">plane.position.y = </span><span class="nx">planeStart</span><span class="p">.</span><span class="nx">y</span> <span class="o">+</span> <span class="p">((</span><span class="o">-</span><span class="nx">deltaY</span> <span class="err">/ (canvas.height * plane.scale.y)) * (2.0 * plane.scale.y))</span>

  <span class="nx">$</span><span class="p">(</span><span class="nx">canvas</span><span class="p">).</span><span class="nx">mousedown</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="vi">@dragging = </span><span class="kc">true</span>
    <span class="vi">@dragStart = </span><span class="p">{</span><span class="nv">x: </span><span class="nx">event</span><span class="p">.</span><span class="nx">offsetX</span><span class="p">,</span> <span class="nv">y: </span><span class="nx">event</span><span class="p">.</span><span class="nx">offsetY</span><span class="p">}</span>
    <span class="vi">@planeStart = </span><span class="p">{</span><span class="nv">x: </span><span class="nx">plane</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nv">y: </span><span class="nx">plane</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span><span class="p">}</span>

  <span class="nx">$</span><span class="p">(</span><span class="nx">canvas</span><span class="p">).</span><span class="nx">mousemove</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="k">return</span> <span class="nx">unless</span> <span class="nx">@dragging</span>
    <span class="nx">panHandler</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span>

  <span class="nx">$</span><span class="p">(</span><span class="nx">canvas</span><span class="p">).</span><span class="nx">mouseup</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="vi">@dragging = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Zoom handler - zoom in/out</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">zoomHandler = </span><span class="nf">(deltaY) -&gt;</span>
    <span class="nx">plane</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">deltaY</span> <span class="o">*</span> <span class="mf">0.05</span><span class="p">)</span>
    <span class="nv">plane.scale.x = </span><span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">plane</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="nv">plane.scale.y = </span><span class="nx">plane</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span>

  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three &gt; canvas&#39;</span><span class="p">).</span><span class="nx">mousemove</span><span class="p">(</span><span class="nx">moveHandler</span><span class="p">)</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three &gt; canvas&#39;</span><span class="p">).</span><span class="nx">mousewheel</span> <span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">delta</span><span class="p">,</span> <span class="nx">deltaX</span><span class="p">,</span> <span class="nx">deltaY</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nx">zoomHandler</span><span class="p">(</span><span class="nx">deltaY</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Fired every animation tick</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">animate = </span><span class="nf">(t) -&gt;</span>
    <span class="nx">camera</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span><span class="nx">scene</span><span class="p">.</span><span class="nx">position</span><span class="p">)</span>
    <span class="nx">renderer</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">scene</span><span class="p">,</span> <span class="nx">camera</span><span class="p">)</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">requestAnimationFrame</span><span class="p">(</span><span class="nx">animate</span><span class="p">,</span> <span class="nx">renderer</span><span class="p">.</span><span class="nx">domElement</span><span class="p">)</span>

  <span class="nx">animate</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>In lieu of a UI, I give you ... window functions!</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">setG = </span><span class="nf">(gain) -&gt;</span>
  <span class="vi">@material.uniforms.diffuseGain.value = </span><span class="nx">gain</span>

<span class="nb">window</span><span class="p">.</span><span class="nv">setL = </span><span class="nf">(lu, lv) -&gt;</span>
  <span class="vi">@material.uniforms.Lu.value = </span><span class="nx">lu</span>
  <span class="vi">@material.uniforms.Lv.value = </span><span class="nx">lv</span>

<span class="nb">window</span><span class="p">.</span><span class="nv">toggleDrawNormalsMode = </span><span class="o">-&gt;</span>
  <span class="vi">@material.uniforms.drawNormalsMode.value = </span><span class="p">(</span><span class="nx">@material</span><span class="p">.</span><span class="nx">uniforms</span><span class="p">.</span><span class="nx">drawNormalsMode</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h3>This does not belong here</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">drawChrominanceData = </span><span class="nf">(ptm) -&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;canvas&gt;&lt;/canvas&gt;&#39;</span><span class="p">)</span>
  <span class="nv">canvas = </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three &gt; canvas&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">canvas.width = </span><span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span>
  <span class="nv">canvas.height = </span><span class="nx">ptm</span><span class="p">.</span><span class="nx">height</span>
  <span class="nv">context = </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s1">&#39;2d&#39;</span><span class="p">)</span>
  <span class="nv">pixelData = </span><span class="nx">context</span><span class="p">.</span><span class="nx">createImageData</span><span class="p">(</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">height</span><span class="p">)</span>
  <span class="k">for</span> <span class="nx">y</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">height</span><span class="p">]</span>
    <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span><span class="p">]</span>
      <span class="nv">i = </span><span class="p">(((</span><span class="nx">ptm</span><span class="p">.</span><span class="nx">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nx">y</span><span class="p">)</span> <span class="o">*</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
      <span class="nv">j = </span><span class="p">(</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">width</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="nx">x</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
      <span class="nx">pixelData</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>   <span class="o">=</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">tex2</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span>
      <span class="nx">pixelData</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">tex2</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
      <span class="nx">pixelData</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ptm</span><span class="p">.</span><span class="nx">tex2</span><span class="p">[</span><span class="nx">j</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
      <span class="nx">pixelData</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">putImageData</span><span class="p">(</span><span class="nx">pixelData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>Entry point</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">loadAndDisplay = </span><span class="nf">(url) -&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three &gt; canvas&#39;</span><span class="p">).</span><span class="nx">remove</span><span class="p">()</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;loading&#39;</span><span class="p">)</span>

  <span class="nv">ptmFile = </span><span class="k">new</span> <span class="nx">BinaryFile</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span>
  <span class="nx">ptmFile</span><span class="p">.</span><span class="nx">load</span> <span class="o">-&gt;</span>
    <span class="nv">ptm = </span><span class="k">new</span> <span class="nx">PTM</span><span class="p">(</span><span class="k">new</span> <span class="nx">DataViewStream</span><span class="p">(</span><span class="nx">ptmFile</span><span class="p">.</span><span class="nx">dataStream</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>Parse and draw the scene</h3>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">ptm</span><span class="p">.</span><span class="nx">parse</span> <span class="o">-&gt;</span>
      <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#three&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;loading&#39;</span><span class="p">)</span>
      <span class="nx">drawScene</span><span class="p">(</span><span class="nx">ptm</span><span class="p">)</span>

<span class="nx">$</span> <span class="o">-&gt;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.rti-file-list a&#39;</span><span class="p">).</span><span class="nx">click</span> <span class="nf">(e) -&gt;</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
    <span class="nx">loadAndDisplay</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">))</span>

  <span class="nx">loadAndDisplay</span><span class="p">(</span><span class="s1">&#39;rti/WLR-tbird-no-distortion_1000.ptm&#39;</span><span class="p">)</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 